<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helios Vital DataSheed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Un gris azulado muy claro */
            color: #333;
            margin: 0;
            display: flex;
            min-height: 100vh;
        }
        #sidebar {
            width: 260px;
            background-color: #1f2937; /* Azul oscuro casi negro para sidebar */
            color: #f3f4f6;
            padding: 1.5rem;
            transition: transform 0.3s ease-in-out;
            transform: translateX(0);
            z-index: 40;
            position: fixed;
            height: 100%;
            overflow-y: auto;
        }
        #sidebar.collapsed {
            transform: translateX(-100%);
        }
        #sidebar h2 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 2rem;
            text-align: center;
            color: #e5e7eb;
            line-height: 1.3;
        }
        #sidebar ul { list-style: none; padding: 0; }
        #sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 0.85rem 1rem;
            color: #d1d5db;
            text-decoration: none;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 0.95rem;
        }
        #sidebar ul li a:hover, #sidebar ul li a.active {
            background-color: #374151; /* Gris oscuro para hover/active en sidebar */
            color: white;
        }
        #sidebar ul li a i { margin-right: 0.85rem; width: 20px; }

        #mainContent {
            flex-grow: 1;
            padding: 2rem;
            margin-left: 260px;
            transition: margin-left 0.3s ease-in-out;
        }
        #mainContent.sidebar-collapsed {
            margin-left: 0;
        }

        #menuToggle {
            position: fixed;
            top: 1.25rem;
            left: 1.25rem; /* Se ajustará con JS */
            background-color: #3b82f6; /* Azul Tailwind */
            color: white;
            border: none;
            padding: 0.7rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            z-index: 50;
            font-size: 1.25rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #menuToggle:hover { background-color: #2563eb; }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #111827; /* Texto oscuro para títulos */
            margin-bottom: 2rem;
        }

        #chartContainer {
            width: 100%;
            height: 550px; /* Altura del contenedor del gráfico */
            margin-bottom: 1rem;
            position: relative;
            background-color: white; /* Fondo blanco para el gráfico */
            padding: 1.5rem; /* Espaciado interno */
            border-radius: 12px; /* Bordes redondeados */
            box-shadow: 0 6px 12px rgba(0,0,0,0.08); /* Sombra sutil */
            overflow-x: auto; /* Clave para el scroll horizontal */
        }
        #vitalSignsChart {
            min-height: 100%; 
        }

        .selectors-container { 
            display: flex;
            flex-wrap: wrap; 
            gap: 1rem; 
            margin-top: 0.5rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .interval-selector-container, .granularity-selector-container, .show-values-container { 
            padding: 1rem;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-grow: 1; 
            min-width: 220px; 
        }
        .show-values-container {
            flex-grow: 0;
            min-width: auto;
        }
        .interval-selector-container label, .granularity-selector-container label, .show-values-container label {
            font-size: 0.95rem;
            font-weight: 500;
            color: #374151;
            margin-right: 0.5rem;
        }
        .interval-selector-container select, .granularity-selector-container select {
            padding: 0.6rem 0.8rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            flex-grow: 1;
        }
        .show-values-container input[type="checkbox"] {
            width: 1.15em;
            height: 1.15em;
            border-radius: 0.25rem;
            border: 1px solid #d1d5db;
            cursor: pointer;
        }
        .show-values-container input[type="checkbox"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .interval-selector-container select:focus, .granularity-selector-container select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        
        .view-container { width: 100%; max-width: 1300px; margin: 0 auto; }
        .config-section, .data-input-section { margin-top: 2rem; padding: 1.75rem; background-color: white; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.08); }
        .config-section h2, .data-input-section h2 { font-size: 1.5rem; font-weight: 600; color: #1f2937; margin-bottom: 1.25rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; }
        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.25rem; margin-bottom: 1.5rem; }
        .grid-form label { display: block; font-size: 0.9rem; margin-bottom: 0.4rem; color: #4b5563; font-weight: 500; }
        .grid-form input, .grid-form select { width: 100%; padding: 0.65rem 0.85rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.95rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .grid-form input:focus, .grid-form select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); }
        .button { background-color: #3b82f6; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 1rem; font-weight: 500; transition: background-color 0.3s ease; display: inline-flex; align-items: center; justify-content: center; }
        .button:hover { background-color: #2563eb; } .button i { margin-right: 0.5rem; }
        #dataTableContainer { margin-top: 1.5rem; max-height: 350px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; }
        #dataTable { width: 100%; border-collapse: collapse; } #dataTable th, #dataTable td { border-bottom: 1px solid #e5e7eb; padding: 0.85rem 1rem; text-align: left; font-size: 0.9rem; }
        #dataTable th { background-color: #f9fafb; position: sticky; top: 0; font-weight: 600; color: #374151; } #dataTable tbody tr:hover { background-color: #f3f4f6; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; margin: auto; padding: 2.5rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 750px; position: relative; }
        .modal-close { color: #aaa; position: absolute; top: 1rem; right: 1.5rem; font-size: 2rem; font-weight: bold; cursor: pointer; } .modal-close:hover, .modal-close:focus { color: #333; }
        #csvUploaderContainer h1 { font-size: 1.75rem; margin-bottom: 1.5rem; color: #111827; } #dropZone { border: 2px dashed #9ca3af; border-radius: 0.5rem; padding: 2rem; text-align: center; margin-bottom: 1.5rem; background-color: #f9fafb; transition: background-color 0.2s ease; cursor: pointer; }
        #dropZone.dragover { background-color: #e0e7ff; border-color: #3b82f6; } #dropZone p { margin: 0; color: #6b7280; } input[type="file"]#csvFileInput, input[type="url"]#googleSheetUrlInput { margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; width: 100%; }
        .button-load-url { background-color: #10b981; margin-bottom: 1.5rem; } .button-load-url:hover { background-color: #059669; }
        .message-box { margin-top: 1rem; padding: 0.85rem; border-radius: 0.5rem; border-width: 1px; border-style: solid; font-size: 0.9rem; } .message-box.success { background-color: #d1fae5; color: #065f46; border-color: #6ee7b7; } .message-box.error { background-color: #fee2e2; color: #991b1b; border-color: #fca5a5; } .message-box.info { background-color: #dbeafe; color: #1e40af; border-color: #93c5fd; }
        #csvDataTableContainerModal { max-height: 280px; overflow-y: auto; margin-top: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; } #csvDataTableModal { width: 100%; border-collapse: collapse; } #csvDataTableModal th, #csvDataTableModal td { border-bottom: 1px solid #e5e7eb; padding: 0.75rem; text-align: left; font-size: 0.875rem; } #csvDataTableModal th { background-color: #f9fafb; position: sticky; top: 0; font-weight: 600; }
    </style>
</head>
<body>
    <button id="menuToggle"><i class="fas fa-bars"></i></button>
    <aside id="sidebar"><h2>Helios Vital DataSheed by iD@ctor</h2><nav><ul><li><a href="#" id="showDashboardLink" class="active"><i class="fas fa-chart-line"></i> Dashboard Gráfico</a></li><li><a href="#" id="showSettingsLink"><i class="fas fa-cog"></i> Configuración Ejes</a></li><li><a href="#" id="openCsvUploader"><i class="fas fa-file-upload"></i> Cargar Datos CSV</a></li></ul></nav></aside>

    <main id="mainContent">
        <div id="dashboardView" class="view-container">
            <h1 class="page-title">Helios Vital DataSheed by iD@ctor</h1>
            <div id="chartContainer"><canvas id="vitalSignsChart"></canvas></div>
            <div class="selectors-container">
                <div class="interval-selector-container">
                    <label for="timeIntervalSelector">Mostrar Rango:</label>
                    <select id="timeIntervalSelector"><option value="24h" selected>Último Día (24h)</option><option value="3days">Últimos 3 Días</option><option value="1week">Última Semana</option><option value="2weeks">Últimas 2 Semanas</option><option value="1month">Último Mes</option></select>
                </div>
                <div class="granularity-selector-container">
                    <label for="granularitySelector">Granularidad:</label>
                    <select id="granularitySelector"><option value="30min">Cada 30 min</option><option value="hourly" selected>Horaria</option><option value="shift">Turnos (8h)</option><option value="daily">Diaria (24h)</option></select>
                </div>
                <div class="show-values-container">
                    <input type="checkbox" id="showValuesCheckbox">
                    <label for="showValuesCheckbox">Mostrar Valores</label>
                </div>
            </div>
            <div class="data-input-section">
                <h2>Registrar Nuevas Constantes</h2>
                <div class="grid-form">
                    <div><label for="inputFecha">Fecha:</label><input type="date" id="inputFecha"></div>
                    <div><label for="inputHoraMinutos">Hora (HH:MM):</label><input type="time" id="inputHoraMinutos"></div>
                    <div><label for="inputTurno">Turno (si no hay hora):</label><select id="inputTurno"><option value="M">Mañana</option><option value="T">Tarde</option><option value="N">Noche</option></select></div>
                    <div><label for="inputTemp">Temperatura (°C):</label><input type="number" step="0.1" id="inputTemp" placeholder="Ej: 36.5"></div>
                    <div><label for="inputTAS">TA Sistólica (mmHg):</label><input type="number" id="inputTAS" placeholder="Ej: 120"></div>
                    <div><label for="inputTAD">TA Diastólica (mmHg):</label><input type="number" id="inputTAD" placeholder="Ej: 80"></div>
                    <div><label for="inputFC">Frec. Cardíaca (lpm):</label><input type="number" id="inputFC" placeholder="Ej: 70"></div>
                    <div><label for="inputFR">Frec. Respiratoria (rpm):</label><input type="number" id="inputFR" placeholder="Ej: 16"></div>
                    <div><label for="inputSatO2">Sat. O₂ (%):</label><input type="number" id="inputSatO2" placeholder="Ej: 98 (opcional)"></div>
                </div>
                <button id="addDataButton" class="button"><i class="fas fa-plus-circle"></i> Añadir y Actualizar</button>
                <div id="dataTableContainer"><h3>Datos Registrados:</h3><table id="dataTable"><thead><tr><th>Fecha</th><th>Hora</th><th>Turno</th><th>T (°C)</th><th>TA (Sis/Dia)</th><th>FC (lpm)</th><th>FR (rpm)</th><th>SatO₂ (%)</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>
        <div id="settingsView" class="view-container" style="display: none;">
            <h1 class="page-title">Configuración de Escalas de Ejes (Y)</h1>
            <div class="config-section"><div class="grid-form"><div><label for="tempMin">Temp Min (°C):</label><input type="number" id="tempMin" value="34"><label for="tempMax" class="mt-2">Temp Max (°C):</label><input type="number" id="tempMax" value="42"></div><div><label for="hrMin">FC Min (lpm):</label><input type="number" id="hrMin" value="40"><label for="hrMax" class="mt-2">FC Max (lpm):</label><input type="number" id="hrMax" value="180"></div><div><label for="rrMin">FR Min (rpm):</label><input type="number" id="rrMin" value="0"><label for="rrMax" class="mt-2">FR Max (rpm):</label><input type="number" id="rrMax" value="50"></div><div><label for="bpMin">TA Min (mmHg):</label><input type="number" id="bpMin" value="40"><label for="bpMax" class="mt-2">TA Max (mmHg):</label><input type="number" id="bpMax" value="220"></div><div><label for="sato2Min">SatO2 Min (%):</label><input type="number" id="sato2Min" value="90"><label for="sato2Max" class="mt-2">SatO2 Max (%):</label><input type="number" id="sato2Max" value="100"></div></div><button id="applyScaleConfig" class="button"><i class="fas fa-ruler-combined"></i> Aplicar Escalas</button></div>
        </div>
    </main>
    <div id="csvUploaderModal" class="modal"><div class="modal-content"><span class="modal-close" id="closeCsvModal">&times;</span><div id="csvUploaderContainer"><h1>Cargar Datos CSV</h1><p class="text-sm text-gray-600 mb-3">Puedes cargar un archivo CSV local o desde una URL de Google Sheets publicada como CSV.</p><label for="googleSheetUrlInput" class="block text-sm font-medium text-gray-700 mb-1">URL de Google Sheet (publicada como CSV):</label><input type="url" id="googleSheetUrlInput" placeholder="Pega aquí la URL del CSV publicado" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vThcYOP6TMxWvWw3n-DfBeQfJSvOmtZe1WpHM3sOl7yus_tvuxgn6tTcmUf5C3oR0CiPglW-7_TOCOI/pub?output=csv" class="mb-2"><button id="loadFromUrlButton" class="button button-load-url w-full"><i class="fas fa-cloud-download-alt"></i>Cargar desde URL</button><p class="text-center my-3 text-gray-500 text-sm font-medium">O carga un archivo local:</p><div id="dropZone"><p><i class="fas fa-file-csv text-3xl text-gray-400 mb-2"></i><br>Arrastra y suelta un archivo CSV aquí, o haz clic para seleccionar.</p></div><input type="file" id="csvFileInput" accept=".csv" class="hidden"> <div id="messageAreaModal" class="message-box info" style="display: none;"></div><div id="csvDataTableContainerModal"><table id="csvDataTableModal"><thead><tr id="csvHeaderRowModal"></tr></thead><tbody id="csvBodyModal"></tbody></table></div></div></div></div>

    <script>
        // --- Datos Globales y Estado ---
        let patientData = []; 
        const exampleStartDate = new Date("2024-08-01"); 
        for (let i = 0; i < 30; i++) { 
            const currentDate = new Date(exampleStartDate);
            currentDate.setDate(exampleStartDate.getDate() + i);
            const dateStr = currentDate.toISOString().split('T')[0];
            const turnos = ['M', 'T', 'N'];
            turnos.forEach((turno, index) => {
                let hora = 8 + (index * 6); 
                let minuto = 0;
                if (i % 2 === 0) minuto = 30;

                patientData.push({
                    fecha: dateStr, turno: turno, 
                    hora: String(hora).padStart(2,'0') + ":" + String(minuto).padStart(2,'0'), 
                    temp: parseFloat((36.0 + Math.random() * 1.5).toFixed(1)), 
                    tas: Math.floor(110 + Math.random() * 20), tad: Math.floor(70 + Math.random() * 15),
                    fc: Math.floor(60 + Math.random() * 40), fr: Math.floor(12 + Math.random() * 10), 
                    sato2: Math.floor(94 + Math.random() * 5) 
                });
            });
        }

        let vitalSignsChart;
        let isSidebarCollapsed = false;
        let currentlyDisplayedData = [];

        // --- Elementos del DOM ---
        const dashboardView = document.getElementById('dashboardView');
        const settingsView = document.getElementById('settingsView');
        const showDashboardLink = document.getElementById('showDashboardLink');
        const showSettingsLink = document.getElementById('showSettingsLink');
        const openCsvUploaderBtn = document.getElementById('openCsvUploader');
        const chartContainer = document.getElementById('chartContainer');
        const timeIntervalSelector = document.getElementById('timeIntervalSelector');
        const granularitySelector = document.getElementById('granularitySelector');
        const showValuesCheckbox = document.getElementById('showValuesCheckbox'); 
        const inputFecha = document.getElementById('inputFecha');
        const inputHoraMinutos = document.getElementById('inputHoraMinutos'); 
        const inputTurno = document.getElementById('inputTurno');
        const inputTemp = document.getElementById('inputTemp');
        const inputTAS = document.getElementById('inputTAS');
        const inputTAD = document.getElementById('inputTAD');
        const inputFC = document.getElementById('inputFC');
        const inputFR = document.getElementById('inputFR');
        const inputSatO2 = document.getElementById('inputSatO2');
        const addDataButton = document.getElementById('addDataButton');
        const dataTableBody = document.querySelector('#dataTable tbody');
        const applyScaleButton = document.getElementById('applyScaleConfig');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const menuToggle = document.getElementById('menuToggle');
        const csvUploaderModal = document.getElementById('csvUploaderModal');
        const closeCsvModal = document.getElementById('closeCsvModal');
        const csvFileInput = document.getElementById('csvFileInput');
        const googleSheetUrlInput = document.getElementById('googleSheetUrlInput');
        const loadFromUrlButton = document.getElementById('loadFromUrlButton');
        const messageAreaModal = document.getElementById('messageAreaModal');
        const dropZone = document.getElementById('dropZone');
        const csvHeaderRowModal = document.getElementById('csvHeaderRowModal');
        const csvBodyModal = document.getElementById('csvBodyModal');

        // --- Lógica de Navegación y UI ---
        function showMainView(viewToShow) { dashboardView.style.display = 'none'; settingsView.style.display = 'none'; if (viewToShow === 'dashboard') dashboardView.style.display = 'block'; else if (viewToShow === 'settings') settingsView.style.display = 'block'; }
        showDashboardLink.addEventListener('click', (e) => { e.preventDefault(); setActiveLink(showDashboardLink); showMainView('dashboard'); setTimeout(() => { if (vitalSignsChart && chartContainer.offsetWidth > 0) vitalSignsChart.resize(); }, 50); });
        showSettingsLink.addEventListener('click', (e) => { e.preventDefault(); setActiveLink(showSettingsLink); showMainView('settings'); });
        openCsvUploaderBtn.addEventListener('click', (e) => { e.preventDefault(); csvUploaderModal.style.display = 'flex'; });
        closeCsvModal.addEventListener('click', () => { csvUploaderModal.style.display = 'none'; messageAreaModal.style.display = 'none'; messageAreaModal.textContent = ''; });
        window.addEventListener('click', (event) => { if (event.target === csvUploaderModal) { csvUploaderModal.style.display = 'none'; messageAreaModal.style.display = 'none'; messageAreaModal.textContent = ''; } });
        menuToggle.addEventListener('click', () => { isSidebarCollapsed = !isSidebarCollapsed; sidebar.classList.toggle('collapsed', isSidebarCollapsed); mainContent.classList.toggle('sidebar-collapsed', isSidebarCollapsed); menuToggle.style.left = isSidebarCollapsed ? '1.25rem' : `calc(260px + 1.25rem)`; setTimeout(() => { if (vitalSignsChart && chartContainer.offsetWidth > 0) vitalSignsChart.resize(); }, 350); });
        menuToggle.style.left = `calc(260px + 1.25rem)`;
        function setActiveLink(activeLink) { document.querySelectorAll('#sidebar nav ul li a').forEach(link => link.classList.remove('active')); if(activeLink) activeLink.classList.add('active'); }
        
        // --- Lógica del Cargador de CSV ---
        // (Tu lógica de CSV existente - sin cambios)
        dropZone.addEventListener('dragover', (event) => { event.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (event) => { event.preventDefault(); dropZone.classList.remove('dragover'); const files = event.dataTransfer.files; if (files.length > 0 && files[0].name.endsWith('.csv')) handleLocalCsvFile(files[0]); else showMessageInModal('Por favor, suelta un archivo CSV.', 'error'); });
        dropZone.addEventListener('click', () => csvFileInput.click());
        csvFileInput.addEventListener('change', (event) => { if (event.target.files.length > 0) handleLocalCsvFile(event.target.files[0]); });
        loadFromUrlButton.addEventListener('click', async () => { const url = googleSheetUrlInput.value.trim(); if (!url) return showMessageInModal('Introduce una URL.', 'error'); if (!url.includes('docs.google.com/spreadsheets') || !url.includes('output=csv')) return showMessageInModal('URL no válida.', 'error'); showMessageInModal('Cargando...', 'info'); try { const response = await fetch(url); if (!response.ok) throw new Error(`Error HTTP: ${response.status}`); const csvContent = await response.text(); processAndDisplayCsvData(csvContent, `URL: ${new URL(url).hostname}`); } catch (error) { showMessageInModal(`Error al cargar: ${error.message}`, 'error'); }});
        function handleLocalCsvFile(file) { showMessageInModal(`Archivo: ${file.name}`, 'info'); const reader = new FileReader(); reader.onload = (e) => processAndDisplayCsvData(e.target.result, file.name); reader.onerror = () => showMessageInModal('Error al leer archivo.', 'error'); reader.readAsText(file); }
        function processAndDisplayCsvData(csvContent, sourceName) { try { const { data, headers } = parseGenericCsv(csvContent); if (data.length === 0) { showMessageInModal(`CSV de '${sourceName}' vacío.`, 'error'); return; } displayCsvDataInModal(data, headers); transformAndSetGlobalPatientData(data, headers, sourceName); } catch (error) { console.error("Error en processAndDisplayCsvData:", error); showMessageInModal(`Error procesando CSV: ${error.message}`, 'error'); }}
        function parseGenericCsv(csvText) { const lines = csvText.trim().split(/\r\n|\n/); if (lines.length === 0) return { data: [], headers: [] }; const headers = lines[0].split(',').map(h => h.trim().toLowerCase()); const data = lines.slice(1).map(line => { const values = line.split(',').map(v => v.trim()); if (values.length === headers.length) return headers.reduce((obj, header, i) => { obj[header] = values[i]; return obj; }, {}); return null; }).filter(row => row !== null); return { data, headers }; }
        
        function transformAndSetGlobalPatientData(parsedCsvData, csvHeaders, sourceNameForMessage = "CSV") {
            const keyMap = { fecha: ['fecha', 'date', 'timestamp'], hora: ['hora', 'time', 'tiempo'], turno: ['turno', 'shift'], temp: ['temp', 'temperatura', 'temperature', 't', 't (°c)'], tas: ['tas', 'sistolica', 'systolic', 'ta sistolica', 'tas (mmhg)'], tad: ['tad', 'diastolica', 'diastolic', 'ta diastolica', 'tad (mmhg)'], fc: ['fc', 'frecuencia cardiaca', 'hr', 'heart rate', 'fc (lpm)'], fr: ['fr', 'frecuencia respiratoria', 'rr', 'respiratory rate', 'fr (rpm)'], sato2: ['sato2', 'saturacion', 'saturation', 'spo2', 'sato2 (%)'] };
            const findHeader = (possibleNames) => { for (const name of possibleNames) { if (csvHeaders.includes(name)) return name; } return null; };
            const transformed = parsedCsvData.map(row => { const newEntry = {}; const fechaHeader = findHeader(keyMap.fecha); if (fechaHeader && row[fechaHeader]) { try { let d; const dateVal = String(row[fechaHeader]); const dMY = dateVal.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/); const yMD = dateVal.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/); if (dMY) d = new Date(parseInt(dMY[3]), parseInt(dMY[2]) - 1, parseInt(dMY[1])); else if (yMD) d = new Date(parseInt(yMD[1]), parseInt(yMD[2]) - 1, parseInt(yMD[3])); else d = new Date(dateVal); if (isNaN(d.getTime())) throw new Error('Fecha CSV inválida'); newEntry.fecha = d.toISOString().split('T')[0]; } catch { return null; }} else { return null; }
                let horaDefinida = false; const horaHeader = findHeader(keyMap.hora); if (horaHeader && row[horaHeader]) { const horaStr = String(row[horaHeader]).trim(); const timeMatch = horaStr.match(/^(\d{1,2}):(\d{1,2})(:(\d{1,2}))?/); if (timeMatch) { newEntry.hora = `${timeMatch[1].padStart(2,'0')}:${timeMatch[2].padStart(2,'0')}`; horaDefinida = true; } }
                if (!horaDefinida) { const turnoHeader = findHeader(keyMap.turno); if (turnoHeader && row[turnoHeader] && ['M','T','N'].includes(String(row[turnoHeader]).toUpperCase())) { newEntry.turno = String(row[turnoHeader]).toUpperCase(); } else { return null; }} else if (!newEntry.turno) { const h = parseInt(newEntry.hora.split(':')[0], 10); if (h >= 7 && h < 14) newEntry.turno = 'M'; else if (h >= 14 && h < 21) newEntry.turno = 'T'; else newEntry.turno = 'N';}
                ['temp', 'tas', 'tad', 'fc', 'fr', 'sato2'].forEach(internalKey => { const headerKey = findHeader(keyMap[internalKey]); if (headerKey && row[headerKey] !== undefined && String(row[headerKey]).trim() !== '') { let value = parseFloat(String(row[headerKey]).replace(',', '.')); if (!isNaN(value)) newEntry[internalKey] = value; }});
                return newEntry;
            }).filter(entry => entry !== null); 
            
            transformed.sort((a,b) => { 
                const tsA = getTimestampFromDataPoint(a); 
                const tsB = getTimestampFromDataPoint(b);
                if (tsA === null && tsB === null) return 0; if (tsA === null) return 1; if (tsB === null) return -1; 
                return tsA - tsB; 
            });
            patientData = transformed; 

            if (patientData.length > 0) { showMessageInModal(`Datos de '${sourceNameForMessage}' procesados. Cerrando en 4s.`, 'success'); updateChartView(); renderDataTable(); setTimeout(() => { csvUploaderModal.style.display = 'none'; messageAreaModal.style.display = 'none'; messageAreaModal.textContent = ''; }, 4000); }
            else { showMessageInModal(`No se pudieron transformar datos válidos del CSV.`, 'error'); if (vitalSignsChart) vitalSignsChart.destroy(); const c = document.getElementById('vitalSignsChart'); if(c){const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);ctx.font="16px Inter";ctx.fillStyle="#555";ctx.textAlign="center";ctx.fillText("No se cargaron datos.",c.width/2,c.height/2);} dataTableBody.innerHTML='';}
        }
        function displayCsvDataInModal(data, headers) { csvHeaderRowModal.innerHTML = headers.map(h => `<th>${h}</th>`).join(''); csvBodyModal.innerHTML = data.map(row => `<tr>${headers.map(h => `<td>${row[h] !== undefined ? row[h] : ''}</td>`).join('')}</tr>`).join(''); }
        function showMessageInModal(text, type = 'info') { messageAreaModal.className = `message-box ${type}`; messageAreaModal.textContent = text; messageAreaModal.style.display = 'block'; }
        
        // --- Lógica del Gráfico ---
        function getTimestampFromDataPoint(dataEntry) {
            if (!dataEntry || !dataEntry.fecha) return null;
            const [year, month, day] = dataEntry.fecha.split('-').map(Number);
            let hour = 8, minute = 0; 
            if (dataEntry.hora) { const timeParts = dataEntry.hora.split(':'); hour = parseInt(timeParts[0], 10); minute = parseInt(timeParts[1], 10) || 0; } 
            else if (dataEntry.turno) { if (dataEntry.turno === 'T') hour = 14; else if (dataEntry.turno === 'N') hour = 20; }
            if (isNaN(hour) || isNaN(minute) || isNaN(year) || isNaN(month) || isNaN(day)) return null; 
            return new Date(year, month - 1, day, hour, minute).valueOf(); 
        }

        function filterAndSortData(data, interval) { 
            if (!data || data.length === 0) { return []; }
            const sortedData = [...data].map(d => ({ ...d, timestamp: getTimestampFromDataPoint(d) })).filter(d => d.timestamp !== null).sort((a, b) => a.timestamp - b.timestamp);
            if (sortedData.length === 0) { return []; }
            const lastDataPointTimestamp = sortedData[sortedData.length - 1].timestamp;
            let latestDateFull = new Date(lastDataPointTimestamp);
            let viewEndDate = new Date(latestDateFull); viewEndDate.setHours(23, 59, 59, 999);
            let startDate = new Date(latestDateFull); startDate.setHours(0,0,0,0); 
            switch(interval){ case '3days':startDate.setDate(startDate.getDate()-2);break; case '1week':startDate.setDate(startDate.getDate()-6);break; case '2weeks':startDate.setDate(startDate.getDate()-13);break; case '1month':const targetMDate=new Date(startDate);targetMDate.setMonth(targetMDate.getMonth()-1);startDate=targetMDate;break;}
            return sortedData.filter(d => d.timestamp >= startDate.getTime() && d.timestamp <= viewEndDate.getTime());
        }
        
        timeIntervalSelector.addEventListener('change', (event) => updateChartView());
        granularitySelector.addEventListener('change', (event) => updateChartView());
        showValuesCheckbox.addEventListener('change', (event) => updateChartView()); 

        function updateChartView() {
            const selectedInterval = timeIntervalSelector.value;
            const selectedGranularity = granularitySelector.value;
            currentlyDisplayedData = filterAndSortData(patientData, selectedInterval);
            createChart(currentlyDisplayedData, selectedInterval, selectedGranularity);
        }
        
        // ========================================================================
        // ===== PLUGIN DE ANOTACIONES PERSONALIZADAS (ACTUALIZADO) =============
        // ========================================================================
        const customAnnotationsPlugin = { 
            id: 'customAnnotations',
            afterDatasetsDraw: (chart) => {
                const { ctx, data, chartArea: { top, bottom, left, right }, scales } = chart;
                if (!currentlyDisplayedData || currentlyDisplayedData.length === 0 || !chart.data.datasets[0] || chartContainer.offsetWidth === 0 || !showValuesCheckbox.checked) return;
                
                ctx.save();
                ctx.font = 'bold 9px Inter';
                ctx.textAlign = 'center';

                // Helper para dibujar texto, evitando que se salga del área del gráfico
                const drawAnnotationText = (text, x, y, color = '#333') => {
                    // Un pequeño padding para que no quede pegado a los bordes
                    const padding = 5;
                    if (x >= left - padding && x <= right + padding && y > top - 15 && y < bottom + 15) {
                        ctx.fillStyle = color;
                        ctx.fillText(text, x, y);
                    }
                };
                
                // Paleta de colores (debe coincidir con la usada en createChart)
                const annotationColors = {
                    temp: '#FFB74D', tas: '#E57373', tad: '#64B5F6',
                    fc: '#4DB6AC', fr: '#90A4AE', sato2: '#BA68C8'
                };

                // Iterar sobre los datos que se están mostrando actualmente en el gráfico
                currentlyDisplayedData.forEach((pData) => {
                    if (!pData.timestamp) return;

                    // Encontrar el índice del punto de dato actual en los datos del gráfico
                    // Asumimos que el primer dataset tiene todos los timestamps o es representativo
                    const chartDataIndex = chart.data.datasets[0].data.findIndex(dp => dp && dp.x && dp.x === pData.timestamp);
                    if (chartDataIndex === -1) return;

                    // Obtener la posición X del punto
                    const baseMeta = chart.getDatasetMeta(0); // Usar el primer dataset para la posición X
                    if (!baseMeta.data || !baseMeta.data[chartDataIndex]) return;
                    const xPos = baseMeta.data[chartDataIndex].x;

                    // Anotación para Tensión Arterial (combinada)
                    if (pData.tas !== undefined && pData.tad !== undefined) {
                        const diastolicDatasetIndex = chart.data.datasets.findIndex(ds => ds.label === 'Diastólica');
                        if (diastolicDatasetIndex !== -1) {
                            const metaTAD = chart.getDatasetMeta(diastolicDatasetIndex);
                            if (metaTAD.data[chartDataIndex] && scales.yBP) {
                                const yPosAnchor = metaTAD.data[chartDataIndex].y;
                                drawAnnotationText(`${pData.tas}/${pData.tad}`, xPos, yPosAnchor + 12, annotationColors.tas);
                            }
                        }
                    }

                    // Anotaciones individuales para otras constantes
                    const annotationsConfig = [
                        { key: 'temp', label: 'Temperatura', color: annotationColors.temp, yOffset: -8 },
                        { key: 'fc', label: 'Frec. Cardíaca', color: annotationColors.fc, yOffset: -8 },
                        { key: 'fr', label: 'Frec. Respiratoria', color: annotationColors.fr, yOffset: 8 },
                        { key: 'sato2', label: 'Sat. O₂', color: annotationColors.sato2, yOffset: 8 }
                    ];

                    annotationsConfig.forEach(config => {
                        if (pData[config.key] !== undefined) {
                            const datasetIndex = chart.data.datasets.findIndex(ds => ds.label === config.label);
                            if (datasetIndex !== -1) {
                                const meta = chart.getDatasetMeta(datasetIndex);
                                if (meta.data[chartDataIndex]) {
                                    const yPos = meta.data[chartDataIndex].y;
                                    drawAnnotationText(String(pData[config.key]), xPos, yPos + config.yOffset, config.color);
                                }
                            }
                        }
                    });
                });
                ctx.restore();
            }
        };


        // ========================================================================
        // ===== FUNCIÓN createChart (NÚCLEO DE LOS CAMBIOS DE ESTILO) ==========
        // ========================================================================
        function createChart(dataToDisplay, interval, granularity) { 
            const chartCanvas = document.getElementById('vitalSignsChart'); 
            const ctxChart = chartCanvas.getContext('2d');

            if (chartContainer.offsetWidth === 0) { if (vitalSignsChart) vitalSignsChart.destroy(); return; }
            if (!dataToDisplay || dataToDisplay.length === 0) { 
                if (vitalSignsChart) vitalSignsChart.destroy(); 
                ctxChart.clearRect(0,0,chartCanvas.width,chartCanvas.height); 
                ctxChart.font="16px Inter"; ctxChart.fillStyle="#555"; ctxChart.textAlign="center"; 
                ctxChart.fillText("No hay datos para período/granularidad.", chartCanvas.width/2, chartCanvas.height/2); 
                chartCanvas.style.width='100%'; 
                return; 
            }
            
            // --- Parámetros de visualización del eje X (tu lógica existente) ---
            let timeUnit, tooltipFormat, minRotation = 0, maxRotation = 50, autoSkip = true, stepSizeX /* no usado directamente en ticks.x */ ;
            let barThickness = 10; // Aunque ya no usamos barras para TA, lo mantenemos por si acaso

            switch(granularity) {
                case '30min': timeUnit = 'minute'; /*stepSizeX = 30;*/ autoSkip = false; tooltipFormat = 'HH:mm dd/MM'; break;
                case 'hourly': timeUnit = 'hour'; /*stepSizeX = 1;*/ autoSkip = false; tooltipFormat = 'HH:mm dd/MM'; break;
                case 'shift': timeUnit = 'hour'; /*stepSizeX = 8;*/ autoSkip = false; tooltipFormat = 'HH:mm dd/MM'; break; 
                case 'daily': timeUnit = 'day'; /*stepSizeX = 1;*/ autoSkip = true; tooltipFormat = 'dd/MM/yy'; break;
                default: timeUnit = 'hour'; /*stepSizeX = 1;*/ autoSkip = false; tooltipFormat = 'HH:mm dd/MM'; 
            }

            if (interval === '24h') { minRotation = 30; autoSkip = false; }
            else if (interval === '3days') { minRotation = 45; autoSkip = false; }
            else if (interval === '1week') { if (granularity === 'hourly' || granularity === 'shift') {timeUnit = 'day';} else if (granularity === '30min') {timeUnit = 'hour';} autoSkip = true;}
            else if (interval === '2weeks') { timeUnit = 'day'; autoSkip = true;}
            else if (interval === '1month') { 
                if (granularity === 'daily' || granularity === 'shift') { timeUnit = 'day'; autoSkip = true; } 
                else { timeUnit = 'hour'; autoSkip = true; }
            }
            // --- Fin parámetros eje X ---

            const timestamps = dataToDisplay.map(d => d.timestamp).filter(ts => ts !== null); 
            let minXDate = timestamps.length > 0 ? new Date(Math.min(...timestamps)) : new Date();
            let maxXDate = timestamps.length > 0 ? new Date(Math.max(...timestamps)) : new Date();
            
            if (timestamps.length > 0) {
                const firstTimestamp = minXDate.valueOf(); const lastTimestamp = maxXDate.valueOf();
                let padding = 3600000 * 1; // 1 hora de padding por defecto
                if (interval === '24h') { minXDate.setHours(0,0,0,0); maxXDate = new Date(minXDate); maxXDate.setHours(23,59,59,999); }
                else { const range = lastTimestamp - firstTimestamp; if (granularity === '30min') padding = Math.max(3600000 * 3, range * 0.05); else if (granularity === 'hourly') padding = Math.max(3600000 * 6, range * 0.05); else if (granularity === 'shift') padding = Math.max(3600000 * 12, range * 0.05); else padding = Math.max(3600000 * 24, range * 0.05); minXDate = new Date(firstTimestamp - padding); maxXDate = new Date(lastTimestamp + padding); }
            }
            
            // --- Definición de Estilos Comunes para las Líneas ---
            const commonLineStyles = {
                type: 'line',
                tension: 0.4, 
                borderWidth: 2.5, 
                pointRadius: 3,
                pointHoverRadius: 5,
                pointBackgroundColor: 'white', 
                pointHoverBackgroundColor: 'white',
                pointBorderWidth: 1.5, 
                pointHoverBorderWidth: 2,
                spanGaps: true 
            };

            // --- Paleta de Colores ---
            const colors = {
                temp: '#FFB74D',   // Naranja Suave
                tas: '#E57373',    // Rojo Suave
                tad: '#64B5F6',    // Azul Claro
                fc: '#4DB6AC',     // Teal/Cyan
                fr: '#90A4AE',     // Gris Azulado
                sato2: '#BA68C8'   // Púrpura Suave
            };

            // --- Definición de DATASETS con el nuevo estilo ---
            const datasets = [
                { ...commonLineStyles, label: 'Temperatura', data: dataToDisplay.map(d => ({ x: d.timestamp, y: d.temp })), borderColor: colors.temp, pointBorderColor: colors.temp, yAxisID: 'yTemp', order: 1 },
                { ...commonLineStyles, label: 'Sistólica', data: dataToDisplay.map(d => ({ x: d.timestamp, y: d.tas })), borderColor: colors.tas, pointBorderColor: colors.tas, yAxisID: 'yBP', order: 2 },
                { ...commonLineStyles, label: 'Diastólica', data: dataToDisplay.map(d => ({ x: d.timestamp, y: d.tad })), borderColor: colors.tad, pointBorderColor: colors.tad, yAxisID: 'yBP', order: 3 },
                { ...commonLineStyles, label: 'Frec. Cardíaca', data: dataToDisplay.map(d => ({ x: d.timestamp, y: d.fc })), borderColor: colors.fc, pointBorderColor: colors.fc, yAxisID: 'yFC', order: 4 },
                { ...commonLineStyles, label: 'Frec. Respiratoria', data: dataToDisplay.map(d => ({ x: d.timestamp, y: d.fr })), borderColor: colors.fr, pointBorderColor: colors.fr, yAxisID: 'yFR', order: 5 },
                { ...commonLineStyles, label: 'Sat. O₂', data: dataToDisplay.map(d => ({ x: d.timestamp, y: d.sato2 })), borderColor: colors.sato2, pointBorderColor: colors.sato2, yAxisID: 'ySatO2', hidden: false, order: 6 }
            ];
            
            // --- Configuración de SCALES (Ejes) ---
            let scalesOptions = {
                x: {
                    type: 'time',
                    time: { unit: timeUnit, tooltipFormat: tooltipFormat, displayFormats: { minute: 'HH:mm', hour: 'HH:mm', day: 'dd/MM', week: 'dd MMM', month: 'MMM yy' }},
                    min: minXDate.valueOf(), max: maxXDate.valueOf(),
                    grid: { display:true, color:'rgba(200,200,200,0.2)', borderColor:'rgba(200,200,200,0.5)', borderDash:[2,3] },
                    ticks: { color:'#555', font:{size:10}, autoSkip:autoSkip, minRotation:minRotation, maxRotation:maxRotation, padding:10 }
                },
                yTemp: { type: 'linear', position: 'left', display: true, min: parseFloat(document.getElementById('tempMin').value), max: parseFloat(document.getElementById('tempMax').value), title: { display: true, text: 'Temp (°C)', color: colors.temp, font:{weight:'bold'}}, ticks: { color: colors.temp, stepSize: 1 }, grid: { drawOnChartArea: false }},
                yBP: { type: 'linear', position: 'left', display: true, min: parseFloat(document.getElementById('bpMin').value), max: parseFloat(document.getElementById('bpMax').value), title: { display: true, text: 'Presión Art. (mmHg)', color: '#555', font:{weight:'bold'}}, ticks: { color: '#555', stepSize: 20 }, grid: { drawOnChartArea: true, color: 'rgba(200,200,200,0.3)', borderColor: 'rgba(200,200,200,0.5)' }},
                yFC: { type: 'linear', position: 'right', display: true, min: parseFloat(document.getElementById('hrMin').value), max: parseFloat(document.getElementById('hrMax').value), title: { display: true, text: 'FC (lpm)', color: colors.fc, font:{weight:'bold'}}, ticks: { color: colors.fc, stepSize: 20 }, grid: { drawOnChartArea: false }},
                ySatO2: { type: 'linear', position: 'right', display: true, min: parseFloat(document.getElementById('sato2Min').value), max: parseFloat(document.getElementById('sato2Max').value), title: { display: true, text: 'Sat. O₂ (%)', color: colors.sato2, font:{weight:'bold'}}, ticks: { color: colors.sato2, stepSize: 2 }, grid: { drawOnChartArea: false }},
                yFR: { type: 'linear', position: 'right', display: true, min: parseFloat(document.getElementById('rrMin').value), max: parseFloat(document.getElementById('rrMax').value), title: { display: true, text: 'FR (rpm)', color: colors.fr, font:{weight:'bold'}}, ticks: { color: colors.fr, stepSize: 5 }, grid: { drawOnChartArea: false }, offset: true }
            };
            
            // --- Lógica para ANCHO DEL CANVAS y SCROLL HORIZONTAL (ajustada) ---
            const currentContainerWidth = chartContainer.offsetWidth;
            let desiredCanvasWidth = currentContainerWidth;
            const numDataPoints = dataToDisplay.length;

            if (numDataPoints > 0 && currentContainerWidth > 0) {
                let minPxPerSlot = 20; 
                let totalSlotsInInterval = 0;
                const dayInMillis = 24 * 60 * 60 * 1000;
                const intervalDurationMillis = maxXDate.valueOf() - minXDate.valueOf();
                const intervalDurationDays = Math.max(1, intervalDurationMillis / dayInMillis);

                if (granularity === '30min') { totalSlotsInInterval = intervalDurationDays * 48; minPxPerSlot = 25; }
                else if (granularity === 'hourly') { totalSlotsInInterval = intervalDurationDays * 24; minPxPerSlot = 30; }
                else if (granularity === 'shift') { totalSlotsInInterval = intervalDurationDays * 3; minPxPerSlot = 60; }
                else if (granularity === 'daily') { totalSlotsInInterval = intervalDurationDays; minPxPerSlot = 70; }

                const widthBasedOnSlots = totalSlotsInInterval * minPxPerSlot;
                const widthBasedOnDataPoints = numDataPoints * 15;
                desiredCanvasWidth = Math.max(currentContainerWidth, widthBasedOnSlots, widthBasedOnDataPoints);
                
                console.log(`[Chart Width Calc] Gran: ${granularity}, Int: ${interval}, ContWidth: ${currentContainerWidth}, Desired: ${desiredCanvasWidth}, Slots: ${totalSlotsInInterval}, Px/Slot: ${minPxPerSlot}`);
            }
            desiredCanvasWidth = Math.min(desiredCanvasWidth, 30000);
            chartCanvas.style.width = `${desiredCanvasWidth}px`;
            // --- Fin lógica ancho canvas ---

            if (vitalSignsChart) vitalSignsChart.destroy();
            vitalSignsChart = new Chart(ctxChart, { 
                data: { datasets: datasets }, 
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false }, 
                    stacked: false, 
                    plugins: { legend: { position: 'bottom', labels: { usePointStyle: true }}, tooltip: {} }, 
                    scales: scalesOptions 
                }, 
                plugins: [customAnnotationsPlugin] 
            });
            
            if (currentContainerWidth > 0) { 
                setTimeout(() => { if (vitalSignsChart) { vitalSignsChart.resize(); } }, 0); 
            }
        }
        // ========================================================================
        
        applyScaleButton.addEventListener('click', () => { 
            // Actualizar también los min/max para SatO2 si es necesario
            document.getElementById('sato2Min').value = scalesOptions.ySatO2.min; // Esto es un ejemplo, debes tener inputs para SatO2
            document.getElementById('sato2Max').value = scalesOptions.ySatO2.max; // o leerlos de los inputs si ya existen.
            updateChartView(); 
            alert("Escalas actualizadas. Vuelve al 'Dashboard Gráfico' para ver cambios."); 
        });
        
        function renderDataTable() { dataTableBody.innerHTML = ''; patientData.forEach(data => { const row = dataTableBody.insertRow(); row.insertCell().textContent = data.fecha || '-'; row.insertCell().textContent = data.hora || '-'; row.insertCell().textContent = data.turno || '-'; row.insertCell().textContent = data.temp !== undefined ? data.temp.toFixed(1) : '-'; row.insertCell().textContent = (data.tas && data.tad) ? `${data.tas}/${data.tad}`: '-'; row.insertCell().textContent = data.fc || '-'; row.insertCell().textContent = data.fr || '-'; row.insertCell().textContent = data.sato2 || '-'; }); }
        inputFecha.valueAsDate = new Date(); 
        addDataButton.addEventListener('click', () => {
            const fecha = inputFecha.value; const hora = inputHoraMinutos.value; const turno = inputTurno.value;
            const temp = parseFloat(inputTemp.value) || undefined; const tas = parseInt(inputTAS.value) || undefined; const tad = parseInt(inputTAD.value) || undefined;
            const fc = parseInt(inputFC.value) || undefined; const fr = parseInt(inputFR.value) || undefined; const sato2 = parseInt(inputSatO2.value) || undefined;
            if (!fecha || (!hora && !turno)) { alert("Por favor, introduce al menos fecha y hora o turno."); return; }
            const newDataPoint = { fecha, hora, turno, temp, tas, tad, fc, fr, sato2 };
            if (!newDataPoint.hora) {
                if (newDataPoint.turno === 'M') newDataPoint.hora = '08:00';
                else if (newDataPoint.turno === 'T') newDataPoint.hora = '16:00';
                else if (newDataPoint.turno === 'N') newDataPoint.hora = '00:00';
            } else if (!newDataPoint.turno) {
                 const h = parseInt(newDataPoint.hora.split(':')[0], 10);
                 if (h >= 7 && h < 14) newDataPoint.turno = 'M'; else if (h >= 14 && h < 21) newDataPoint.turno = 'T'; else newDataPoint.turno = 'N';
            }
            patientData.push(newDataPoint);
            patientData.sort((a,b) => getTimestampFromDataPoint(a) - getTimestampFromDataPoint(b));
            [inputTemp, inputTAS, inputTAD, inputFC, inputFR, inputSatO2, inputHoraMinutos].forEach(el => el.value = ''); inputFecha.valueAsDate = new Date();
            renderDataTable(); updateChartView();
        });

        // --- Inicialización ---
        showMainView('dashboard'); setActiveLink(showDashboardLink);
        setTimeout(() => {
            updateChartView(); 
            renderDataTable();
        }, 100);
    </script>
</body>
</html>
